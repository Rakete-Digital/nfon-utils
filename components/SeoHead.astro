---
import { SEO, type TwitterCardType } from "astro-seo";

export interface Alternate {
  href: string;
  hreflang: string;
}

export interface Props {
  story?: any;
  canonical?: { href?: string; hreflang?: string };
  alternates?: Alternate[];

  // Optional overrides
  title?: string;
  titleDefault?: string;
  description?: string;
  keywords?: string;
  author?: string;
  url?: string;
  noindex?: boolean;

  ogTitle?: string;
  ogDescription?: string;
  ogImage?: string;

  twitterTitle?: string;
  twitterDescription?: string;
  twitterImage?: string;
  twitterCard?: TwitterCardType;

  robots?: string;
  charset?: string;
  refresh?: string;
  viewport?: string;
  contentType?: string;

  icons?: { rel: string; href: string }[];
  sitemap?: string;
}

const {
  story,
  canonical,
  alternates,

  title,
  titleDefault = "NFON",
  description,
  keywords,
  author,
  url,
  noindex,

  ogTitle,
  ogDescription,
  ogImage,

  twitterTitle,
  twitterDescription,
  twitterImage,
  twitterCard,

  robots,
  charset,
  refresh,
  viewport,
  contentType,

  icons,
  sitemap,
} = Astro.props;

// Storyblok fallbacks
const c = story?.content || {};
const ai = c.seo_plugin || {};

const pick = (prop?: string, aiValue?: string, cValue?: string, fallback?: string) =>
  prop ?? (aiValue && aiValue.trim() !== "" ? aiValue : cValue || fallback || undefined);

const seo = {
  title: pick(title, ai.title, c.Title || story?.name),
  description: pick(description, ai.description, c.description),
  keywords: pick(keywords, ai.keywords, c.keywords),
  noindex: noindex ?? c.noindex ?? false,
  author: pick(author, ai.author, c.author),
  url: pick(url, ai["og:url"], canonical?.href),

  ogTitle: pick(ogTitle, ai["og:title"], c.og_title || c.Title || story?.name),
  ogDescription: pick(ogDescription, ai["og:description"], c.og_description || c.description),
  ogImage: pick(ogImage, ai["og:image"], c.og_image?.filename),

  twitterTitle: pick(twitterTitle, ai["twitter:title"], c.Title || story?.name),
  twitterDescription: pick(twitterDescription, ai["twitter:description"], c.description),
  twitterImage: pick(twitterImage, ai["twitter:image"], c.og_image?.filename),
  twitterCard: twitterCard ?? (ai["twitter:card"] as TwitterCardType) ?? "summary_large_image",

  robots: pick(robots, ai["advanced:robots"]),
  charset: pick(charset, ai["advanced:charset"], undefined, "utf-8"),
  refresh: pick(refresh, ai["advanced:refresh"]),
  viewport: pick(viewport, ai["advanced:viewport"], undefined, "width=device-width, initial-scale=1"),
  canonical: pick(canonical?.href, ai["advanced:canonical"], canonical?.href),
  contentType: pick(contentType, ai["advanced:content-type"], undefined, "text/html; charset=utf-8"),
};

// Meta array
const meta: Partial<import("astro-seo").Meta>[] = [];
if (seo.keywords) meta.push({ name: "keywords", content: seo.keywords });
if (seo.robots) meta.push({ name: "robots", content: seo.robots });
if (seo.contentType) meta.push({ httpEquiv: "Content-Type", content: seo.contentType });
if (seo.refresh) meta.push({ httpEquiv: "refresh", content: seo.refresh });
if (seo.viewport) meta.push({ name: "viewport", content: seo.viewport });

// Link array
const link: { rel: string; href: string; hreflang?: string }[] = [];
if (icons) link.push(...icons);
else {
  link.push(
    { rel: "icon", href: "/assets/favicon.png" },
    { rel: "apple-touch-icon", href: "/assets/logo-nfon.svg" },
    { rel: "msapplication-TileImage", href: "/assets/logo-nfon.svg" }
  );
}
if (sitemap) link.push({ rel: "sitemap", href: sitemap });

// Alternates
if (alternates && alternates.length > 0) {
  alternates.forEach((alt) => link.push({ rel: "alternate", href: alt.href, hreflang: alt.hreflang }));
}

// Canonical
if (seo.canonical) link.push({ rel: "canonical", href: seo.canonical });
---

<SEO
  titleDefault={titleDefault}
  title={seo.title}
  description={seo.description}
  charset={seo.charset}
  openGraph={{
    basic: {
      title: seo.ogTitle || "",
      type: "website",
      image: seo.ogImage || "",
      url: seo.url || "",
    },
    image: {
      alt: seo.ogTitle || seo.title,
      height: 1920,
      width: 2400,
      url: seo.ogImage,
    },
    article: {
      authors: seo.author ? [seo.author] : [],
    },
  }}
  twitter={{
    card: seo.twitterCard,
    title: seo.twitterTitle,
    description: seo.twitterDescription,
    image: seo.twitterImage,
  }}
  extend={{
    link,
    meta,
  }}
/>
